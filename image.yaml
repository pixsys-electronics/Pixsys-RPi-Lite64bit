{{- $arch     := or .arch     "armhf" -}}
{{- $suite    := or .suite    "buster" -}}
{{- $board    := or .board    "rmb200" -}}
{{- $flavour  := or .flavour  "WP830-1AD" -}}
{{- $kernel   := or .kernel   "5.15.30-v7l-wp830-g1fe617a917ea" -}}
{{- $timezone := or .timezone "Europe/Rome" -}}
{{- $commit   := or .commit   "devel" -}}
{{- $archive  := or .archive  (printf "debian-%s-%s.tgz" $suite $arch) -}}
{{- $image    := or .image    (printf "%s_Rev.%s_%s.img" $flavour $commit $kernel) -}}
{{- $update   := or .update   (printf "%s_Update_Rev.%s_%s.tgz" $flavour $commit $kernel) -}}

architecture: {{ $arch }}

actions:
  - action: unpack
    file: {{ $archive }}
    compression: gz

  - action: overlay
    description: add bootloader files
    source: overlays/bootloader/{{ $board }}

  - action: overlay
    description: add kernel, dtb and modules
    source: overlays/kernel/{{ $board }}/{{ $kernel }}

  - action: overlay
    description: script to control the front terminal panel
    source: overlays/terminal/{{ $board }}

  - action: overlay
    description: device specific data, with hooks for persisting it
    source: overlays/deviceinfo

  - action: overlay
    description: script to configure board via udp broadcast
    source: overlays/finder

  - action: overlay
    description: hook for first boot actions via /etc/rc.local
    source: overlays/firstboot

  - action: overlay
    description: add mbusd
    source: overlays/mbusd

  - action: overlay
    description: add authorized_keys for root
    source: overlays/authorized_keys

  - action: run
    description: create pixsys user
    chroot: true
    script: scripts/pixsys.sh

  - action: overlay
    description: add pixsys portal
    source: overlays/pixsysportal

  - action: overlay
    description: configuration for wifi hotspot
    source: overlays/hostapd

  - action: recipe
    description: extra configuration
    recipe: flavours/{{ $flavour }}.yaml

  - action: run
    description: set timezone
    chroot: true
    script: scripts/setup-timezone.sh "{{ $timezone }}"

  - action: run
    description: create /etc/pixsys.info
    chroot: true
    script: scripts/pixsys-info.sh "{{ $arch }}" "{{ $suite }}" "{{ $board }}" "{{ $flavour }}" "{{ $kernel }}" "{{ $commit }}"

  - action: run
    description: do not write systemd journal to disk
    chroot: true
    command: rm -rf /var/log/journal/

  - action: pack
    file: {{ $update }}
    compression: gz

  - action: image-partition
    description: create a partitioned image
    imagename: {{ $image }}
    imagesize: 2GB
    partitiontype: msdos
    mountpoints:
      - mountpoint: /
        partition: rootfs
        options: [ noatime ]
      - mountpoint: /data
        partition: data
        options: [ noatime ]
    partitions:
      - name: rootfs
        fs: ext4
        start: 16M
        end: 1GB
        flags: [ boot ]
      - name: data
        fs: ext4
        start: 1GB
        end: 100%

  - action: filesystem-deploy
    description: deploying filesystem onto image
    setup-kernel-cmdline: false

  - action: run
    description: setup MLO and uboot.img
    script: scripts/uboot.sh

  - action: run
    description: obtain a bitmap file for faster flashing
    postprocess: true
    command: bmaptool create {{ $image }} -o {{ $image }}.bmap

  - action: run
    description: compress the image
    postprocess: true
    command: xz -T 0 -f {{ $image }}
