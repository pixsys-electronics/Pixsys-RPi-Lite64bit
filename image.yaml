{{- $arch     := or .arch     "armhf" -}}
{{- $suite    := or .suite    "buster" -}}
{{- $board    := or .board    "rmb200" -}}
{{- $flavour  := or .flavour  "WP830-1AD" -}}
{{- $kernel   := or .kernel   "5.15.30-v7l-wp830-g1fe617a917ea" -}}
{{- $timezone := or .timezone "Europe/Rome" -}}
{{- $commit   := or .commit   "devel" -}}
{{- $archive  := or .archive  (printf "debian-%s-%s.tgz" $suite $arch) -}}
{{- $image    := or .image    "wp830-1ad.img" -}}
{{- $update   := or .update   (printf "%s_Update_Rev.%s_%s.tgz" $flavour $commit $kernel) -}}

architecture: {{ $arch }}

actions:
  - action: download
    url: https://downloads.raspberrypi.org/raspios_armhf/root.tar.xz
    #url: https://downloads.raspberrypi.org/raspios_full_armhf/root.tar.xz
    name: root
    unpack: false

  - action: unpack
    origin: root
    compression: xz


#  - action: unpack
#    file: root.tar.xz
#    compression: xz

  - action: download
    url: https://downloads.raspberrypi.org/raspios_armhf/boot.tar.xz
    #url: https://downloads.raspberrypi.org/raspios_full_armhf/boot.tar.xz
    name: boot
    unpack: true
    compression: xz

  - action: overlay
    origin: boot
    destination: /boot

  - action: overlay
    description: WP830 device specific file
    source: overlays/wp830

  - action: overlay
    description: device specific data, with hooks for persisting it
    source: overlays/deviceinfo

  - action: overlay
    description: hook for first boot actions via /etc/rc.local
    source: overlays/firstboot

  - action: image-partition
    description: create a partitioned image
    imagename: {{ $image }}
    imagesize: 8GB
    partitiontype: msdos
    mountpoints:
      - mountpoint: /boot
        partition: boot
        options: [noatime]
      - mountpoint: /
        partition: root
        options: [noatime]
    partitions:
      - name: boot
        fs: fat32
        start: 1M
        end: 256M
        flags: [boot]
      - name: root
        fs: ext4
        start: 257M
        end: 100%

  - action: run
    description: Update PARTUUID
    command: perl -i -pe "s{XXXXXXXX}{$(blkid -o export ${IMAGE}|grep PTUUID|cut -f2 -d=)}" ${ROOTDIR}/boot/cmdline.txt

  - action: filesystem-deploy
    description: deploying filesystem onto image
    #setup-fstab: false
    setup-kernel-cmdline: false

  - action: run
    description: obtain a bitmap file for faster flashing
    postprocess: true
    command: bmaptool create {{ $image }} -o {{ $image }}.bmap

  - action: run
    description: compress the image
    postprocess: true
    command: xz -T 0 -f {{ $image }}

