var LLWebServer=function(){const XHR_READY_STATE={UNSENT:0,OPENED:1,HEADERS_RECEIVED:2,LOADING:3,DONE:4};const HTTP_STATUS={OK:200};var m_imgsVarsMap={};var m_nextAutoID=0;document.addEventListener("DOMContentLoaded",InitWriteControls,false);const ATTR_NAME_SYM="data-llweb-sym";const ATTR_NAME_PAR="data-llweb-par";const ATTR_NAME_REFRESH="data-llweb-refresh";const ATTR_NAME_IMG_FILES="data-llweb-img";const ATTR_NAME_FORMAT="data-llweb-format";const URL_SYM="/api/sym?";const URL_PAR="/api/par?";const URL_PARLIST="/api/parlist?";const URL_MENULIST="/api/menulist?";const URL_SYMLIST="/api/symlist?";const URL_LIC_STATUS="/api/sys/licensestatus";const URL_PLC_STATUS="/api/sys/status";const URL_REG_LIC="/api/sys/licenseregister";const URL_PRODUCTLIST="/api/sys/productlist";const URL_SYSLOG="/api/sys/log";const URL_START_PLC="/api/sys/start";const URL_RESTART_PLC="/api/sys/restart";const URL_STOP_PLC="/api/sys/stop";const URL_SHUTDOWN="/api/sys/shutdown";const URL_CHECK_SESSION="/api/sys/admstate";const URL_LOGIN="/api/sys/admlogin";const URL_LOGOUT="/api/sys/admlogout";const LINESEP="\r\n";const IMG_FOLDER_NAME="img";function GetSymValues(names,async,callbackFunc){if(async&&!callbackFunc)return false;var xhttp=new XMLHttpRequest;var resultValues=null;xhttp.onreadystatechange=function(){if(this.readyState==XHR_READY_STATE.DONE){if(this.status==HTTP_STATUS.OK){var values=this.responseText.split(LINESEP);if(values[values.length-1]=="")values.pop();if(callbackFunc)callbackFunc(values);if(!async)resultValues=values}else{if(callbackFunc)callbackFunc(null)}}};xhttp.open("GET",URL_SYM+names.join("&"),async);try{xhttp.send()}catch(ex){if(callbackFunc)callbackFunc(null);return false}if(!async)return resultValues}function GetParValues(ipas,async,callbackFunc){if(async&&!callbackFunc)return false;var xhttp=new XMLHttpRequest;var resultValues=null;xhttp.onreadystatechange=function(){if(this.readyState==XHR_READY_STATE.DONE){if(this.status==HTTP_STATUS.OK){var values=this.responseText.split(LINESEP);if(values[values.length-1]=="")values.pop();if(callbackFunc)callbackFunc(values);if(!async)resultValues=values}else{if(callbackFunc)callbackFunc(null)}}};xhttp.open("GET",URL_PAR+ipas.join("&"),async);try{xhttp.send()}catch(ex){if(callbackFunc)callbackFunc(null);return false}if(!async)return resultValues}function SetSymValues(values,async){var assignments=[];for(var name in values)assignments.push(name+"="+values[name]);var xhttp=new XMLHttpRequest;xhttp.open("PUT",URL_SYM+assignments.join("&"),async);try{xhttp.send()}catch(ex){return false}return true}function SetParValues(values,async){if(async===undefined)async=true;var assignments=[];for(var ipa in values)assignments.push(ipa+"="+values[ipa]);var xhttp=new XMLHttpRequest;xhttp.open("PUT",URL_PAR+assignments.join("&"),async);try{xhttp.send()}catch(ex){return false}return true}function InitWriteControls(){let symCtrls=document.querySelectorAll("["+ATTR_NAME_SYM+"], ["+ATTR_NAME_PAR+"]");for(let ctrlKey in symCtrls){let ctrl=symCtrls[ctrlKey];if(ctrl.tagName==="INPUT"){if(ctrl.type==="text"){ctrl.addEventListener("keydown",(function(event){const KEY_ENTER=13;const KEY_TAB=9;let mobileOrTablet=isDeviceMobileOrTablet();if(event.keyCode===KEY_ENTER||mobileOrTablet&&event.keyCode===KEY_TAB){OnWriteVar(event,ctrl.value)}if(mobileOrTablet&&event.keyCode===KEY_TAB)event.preventDefault()}))}else if(ctrl.type==="radio"||ctrl.type=="checkbox"||ctrl.type=="button"){ctrl.addEventListener("click",(function(event){let value=ctrl.value;if(ctrl.type=="checkbox")value=ctrl.checked;OnWriteVar(event,value)}))}}else if(ctrl.tagName==="BUTTON"){ctrl.addEventListener("click",(function(event){OnWriteVar(event,ctrl.value)}))}else if(ctrl.tagName==="SELECT"){ctrl.addEventListener("change",(function(event){OnWriteVar(event,ctrl.value)}))}else if(ctrl.tagName==="IMG"){let readonlyAttr=ctrl.getAttribute("data-readonly");if(readonlyAttr===null||readonlyAttr==="false"){ctrl.addEventListener("click",(function(event){let imgsMap=GetImgValuesMap(ctrl);if(imgsMap){let currSrC=ctrl.getAttribute("src");let imgVarsKeys=Object.keys(imgsMap);let currentVal=imgVarsKeys[0];for(let key in imgsMap){if(IMG_FOLDER_NAME+"/"+imgsMap[key]==currSrC){currentVal=key;break}}let nextVal;for(let i=0,j=imgVarsKeys.length;i<j;i++){if(imgVarsKeys[i]==currentVal){if(i+1>=j)nextVal=imgVarsKeys[0];else nextVal=imgVarsKeys[i+1];break}}let symName=ctrl.getAttribute(ATTR_NAME_SYM);if(symName){let symObj={};symObj[symName]=nextVal;SetSymValues(symObj,false)}else{let parAddr=ctrl.getAttribute(ATTR_NAME_SYM);let parObj={};parObj[parAddr]=nextVal;SetParValues(parObj,false)}}}))}}}}function OnWriteVar(event,value){let symName=event.target.getAttribute(ATTR_NAME_SYM);if(symName){let symObj={};symObj[symName]=value;SetSymValues(symObj,false)}else{let parAddr=event.target.getAttribute(ATTR_NAME_SYM);let parObj={};parObj[parAddr]=value;SetParValues(parObj,false)}event.target.blur()}function CompareNoCase(str1,str2){return str1.toLowerCase()==str2.toLowerCase()}function BoolToNum(str){if(CompareNoCase(str,"true"))return"1";else if(CompareNoCase(str,"false"))return"0";else return str}function GetImgValuesMap(ctrl){let imgAttributesObj;if(m_imgsVarsMap[ctrl.id]){imgAttributesObj=m_imgsVarsMap[ctrl.id]}else{let imgsAttribute=ctrl.getAttribute(ATTR_NAME_IMG_FILES);if(imgsAttribute){imgsAttribute=imgsAttribute.replace(/ /g,"");let imgAttributesArr=imgsAttribute.split(",");imgAttributesObj={};imgAttributesArr.forEach((function(attr){let attribute=attr.split(":");let value=BoolToNum(attribute[0]);imgAttributesObj[value]=attribute[1]}));if(!ctrl.id){ctrl.id="autoid_"+m_nextAutoID;m_nextAutoID++}m_imgsVarsMap[ctrl.id]=imgAttributesObj}}return imgAttributesObj}function UpdateControls(controls,periodMs,async){function UpdateControlsWithValues(controls,values){for(var i=0;i<controls.length;i++){var ctrl=controls[i];let activeCtrl=document.activeElement;if(activeCtrl==ctrl)continue;var newVal;if(values&&values.length===controls.length)newVal=values[i];else newVal="###";if(ctrl.tagName==="INPUT"){if(ctrl.type==="radio")ctrl.checked=newVal==ctrl.value;else if(ctrl.type==="checkbox")ctrl.checked=ParseBoolean(newVal);else if(ctrl.type==="text"){var format=ctrl.getAttribute(ATTR_NAME_FORMAT);if(format)ctrl.value=sprintf(format,newVal);else ctrl.value=newVal}else if(ctrl.type==="button")SetStyleToActiveButton(ctrl,ctrl.value==newVal)}else if(ctrl.tagName==="SELECT"){ctrl.value=newVal}else if(ctrl.tagName==="IMG"){let imgAttributesObj=GetImgValuesMap(ctrl);let imgfile=imgAttributesObj[BoolToNum(newVal)];if(imgfile)ctrl.src=IMG_FOLDER_NAME+"/"+imgfile;else ctrl.src=""}else if(ctrl.tagName==="BUTTON")SetStyleToActiveButton(ctrl,ctrl.value==newVal);else ctrl.innerHTML=newVal}}function DoUpdate(){if(symControls.length!=0){GetSymValues(symNames,async,(function(values){UpdateControlsWithValues(symControls,values)}))}if(parControls.length!=0){GetParValues(parIpas,async,(function(values){UpdateControlsWithValues(parControls,values)}))}}function SetStyleToActiveButton(ctrl,active){if(active)ctrl.classList.add("active");else ctrl.classList.remove("active")}if(async===undefined)async=true;if(periodMs===undefined)periodMs=0;if(controls===undefined)controls=document.querySelectorAll("["+ATTR_NAME_SYM+"], ["+ATTR_NAME_PAR+"]");var symControls=[];var symNames=[];var parControls=[];var parIpas=[];for(var i=0;i<controls.length;i++){var ctrl=controls[i];if(typeof ctrl==="string"){ctrl=document.getElementById(ctrl);if(!ctrl)continue}var symName=ctrl.getAttribute(ATTR_NAME_SYM);if(symName){symControls.push(ctrl);symNames.push(symName)}else{var parIpa=ctrl.getAttribute(ATTR_NAME_PAR);if(parIpa){parControls.push(ctrl);parIpas.push(parIpa)}}}if(periodMs===0)DoUpdate();else return setInterval(DoUpdate,periodMs)}var m_autoRefreshTimer=null;function AutoRefreshStart(periodMs){var controls=document.querySelectorAll("*["+ATTR_NAME_REFRESH+" = 'true']");m_autoRefreshTimer=UpdateControls(controls,periodMs,true)}function AutoRefreshStop(){if(m_autoRefreshTimer!==null){clearInterval(m_autoRefreshTimer);m_autoRefreshTimer=null}}function GetParList(menuID){var xhttp=new XMLHttpRequest;var resultList;xhttp.onreadystatechange=function(){if(this.readyState==XHR_READY_STATE.DONE&&this.status==HTTP_STATUS.OK)resultList=JSON.parse(this.responseText)};xhttp.open("GET",URL_PARLIST+"id="+menuID,false);try{xhttp.send()}catch(ex){return}return resultList}function GetSymList(query){var xhttp=new XMLHttpRequest;var resultList;xhttp.onreadystatechange=function(){if(this.readyState==XHR_READY_STATE.DONE&&this.status==HTTP_STATUS.OK)resultList=JSON.parse(this.responseText)};xhttp.open("GET",URL_SYMLIST+"name="+query,false);try{xhttp.send()}catch(ex){return}return resultList}function GetMenuList(menuID,recursive){var xhttp=new XMLHttpRequest;var resultList;xhttp.onreadystatechange=function(){if(this.readyState==XHR_READY_STATE.DONE&&this.status==HTTP_STATUS.OK)resultList=JSON.parse(this.responseText)};xhttp.open("GET",URL_MENULIST+"id="+menuID+"&recursive="+(recursive?1:0),false);try{xhttp.send()}catch(ex){return}return resultList}function GetLicenseStatus(productName){let data={};data["product"]=productName;let result=getDataSync(URL_LIC_STATUS,data);return result}function GetRuntimeStatus(callbackFunc){getDataAsync(URL_PLC_STATUS,null,(function(res){if(res&&callbackFunc)callbackFunc(res)}))}function GetProductList(){let result=getDataSync(URL_PRODUCTLIST);return result}function GetSystemLog(mask,startLine,numLines,callbackFunc){let data={};if(mask)data["mask"]=mask;if(startLine)data["startLine"]=startLine;if(numLines)data["numLines"]=numLines;getDataAsync(URL_SYSLOG,data,(function(res){if(res&&callbackFunc)callbackFunc(res)}))}function RegisterLicense(productName,productLicenseKey){let data={};data["product"]=productName;data["license"]=productLicenseKey;let res=putDataSync(URL_REG_LIC,data);return res}function StartPLC(){let res=putDataSync(URL_START_PLC);return res}function StopPLC(){let res=putDataSync(URL_STOP_PLC);return res}function RestartPLC(){let res=putDataSync(URL_RESTART_PLC);return res}function ShutdownRuntime(){let res=putDataSync(URL_SHUTDOWN);return res}function Login(password,username){let data={};data["password"]=password;data["username"]=username;let res=putDataSync(URL_LOGIN,data);return res}function Logout(){let res=putDataSync(URL_LOGOUT);return res}function CheckSessionIsValid(){let result=getDataSync(URL_CHECK_SESSION);return result}function getDataSync(url,data){let dataStr=getAJAXString(data);let getUrl=url+dataStr;let xhr=new XMLHttpRequest;var result;xhr.onreadystatechange=function(){if(this.readyState==XHR_READY_STATE.DONE&&this.status==HTTP_STATUS.OK)result=parseJSON(this.responseText)};xhr.open("GET",getUrl,false);try{xhr.send()}catch(ex){return}return result}function getDataAsync(url,data,callback){if(!callback)console.error("Callback function is not valid");let dataStr=getAJAXString(data);let getUrl=url+dataStr;let xhr=new XMLHttpRequest;xhr.onreadystatechange=function(){if(this.readyState==XHR_READY_STATE.DONE&&this.status==HTTP_STATUS.OK){let jsonData=parseJSON(xhr.responseText);callback(jsonData)}};xhr.open("GET",getUrl,true);try{xhr.send()}catch(ex){callback(null)}}function putDataSync(url,data){let dataStr=getAJAXString(data);let putUrl=url+dataStr;let xhr=new XMLHttpRequest;var result;xhr.onreadystatechange=function(){if(this.readyState==XHR_READY_STATE.DONE)result=parseJSON(this.responseText)};xhr.open("PUT",putUrl,false);try{xhr.send(dataStr)}catch(ex){return}return result}function parseJSON(JSONStr){try{let data=JSON.parse(JSONStr);return data}catch(e){console.error("Error parsing JSON: "+e);return null}}function getAJAXString(data){let date=new Date;let cacheStr=date.getMinutes()+""+date.getSeconds()+""+date.getMilliseconds();if(data===undefined||data===null)data={};data["_noCache"]=cacheStr;let dataArr=[];for(let key in data){let value=data[key];if(!value)continue;dataArr.push(key+"="+value)}let dataStr="";if(dataArr.length>0)dataStr=dataArr.join("&");const PARAMS_PREFIX="?";if(dataStr!=="")dataStr=PARAMS_PREFIX+dataStr;return dataStr}function GetLicense(productName,hardwareId,productKey,callbackFunc){if(!hardwareId||!productKey||!productName)return;let data={};data["hwi"]=hardwareId;data["pKey"]=productKey;data["pro"]=productName;const URL="https://www.axelsw.it/reg/llexeckey.php";let dataStr=getAJAXString(data);let getUrl=URL+dataStr;let xhr=new XMLHttpRequest;xhr.onreadystatechange=function(){if(this.readyState==XHR_READY_STATE.DONE){if(this.status==HTTP_STATUS.OK)callbackFunc(xhr.responseText);else callbackFunc(null)}};xhr.open("GET",getUrl,true);xhr.setRequestHeader("X-REGLIC","pingpong");try{xhr.send()}catch(ex){callbackFunc(null)}}function ParseBoolean(s){if(s==="false"||s==="0"||s==="FALSE")return false;else if(s==="true"||s==="1"||s==="TRUE")return true;else if(s!=""&&!isNaN(parseInt(s))&&parseInt(s)!=0)return true;else return false}function isDeviceMobileOrTablet(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent)}function sprintf(){function pad(str,len,chr,leftJustify){var padding=str.length>=len?"":Array(1+len-str.length>>>0).join(chr);return leftJustify?str+padding:padding+str}function justify(value,prefix,leftJustify,minWidth,zeroPad){var diff=minWidth-value.length;if(diff>0){if(leftJustify||!zeroPad)value=pad(value,minWidth," ",leftJustify);else value=value.slice(0,prefix.length)+pad("",diff,"0",true)+value.slice(prefix.length)}return value}function formatBaseX(value,base,prefix,leftJustify,minWidth,precision,zeroPad){var number=value>>>0;prefix=prefix&&number&&{2:"0b",8:"0",16:"0x"}[base]||"";value=prefix+pad(number.toString(base),precision||0,"0",false);return justify(value,prefix,leftJustify,minWidth,zeroPad)}function formatString(value,leftJustify,minWidth,precision,zeroPad){if(precision!=null)value=value.slice(0,precision);return justify(value,"",leftJustify,minWidth,zeroPad)}var a=arguments,i=0,format=a[i++];return format.replace(sprintf.regex,(function(substring,valueIndex,flags,minWidth,_,precision,type){if(substring=="%%")return"%";var leftJustify=false,positivePrefix="",zeroPad=false,prefixBaseX=false;for(var j=0;flags&&j<flags.length;j++)switch(flags.charAt(j)){case" ":positivePrefix=" ";break;case"+":positivePrefix="+";break;case"-":leftJustify=true;break;case"0":zeroPad=true;break;case"#":prefixBaseX=true;break}if(!minWidth)minWidth=0;else if(minWidth=="*")minWidth=+a[i++];else if(minWidth.charAt(0)=="*")minWidth=+a[minWidth.slice(1,-1)];else minWidth=+minWidth;if(minWidth<0){minWidth=-minWidth;leftJustify=true}if(!isFinite(minWidth))throw new Error("sprintf: (minimum-)width must be finite");if(!precision)precision="fFeE".indexOf(type)>-1?6:type=="d"?0:void 0;else if(precision=="*")precision=+a[i++];else if(precision.charAt(0)=="*")precision=+a[precision.slice(1,-1)];else precision=+precision;var value=valueIndex?a[valueIndex.slice(0,-1)]:a[i++];switch(type){case"s":return formatString(String(value),leftJustify,minWidth,precision,zeroPad);case"c":return formatString(String.fromCharCode(+value),leftJustify,minWidth,precision,zeroPad);case"b":return formatBaseX(value,2,prefixBaseX,leftJustify,minWidth,precision,zeroPad);case"o":return formatBaseX(value,8,prefixBaseX,leftJustify,minWidth,precision,zeroPad);case"x":return formatBaseX(value,16,prefixBaseX,leftJustify,minWidth,precision,zeroPad);case"X":return formatBaseX(value,16,prefixBaseX,leftJustify,minWidth,precision,zeroPad).toUpperCase();case"u":return formatBaseX(value,10,prefixBaseX,leftJustify,minWidth,precision,zeroPad);case"i":case"d":{var number=parseInt(+value);var prefix=number<0?"-":positivePrefix;value=prefix+pad(String(Math.abs(number)),precision,"0",false);return justify(value,prefix,leftJustify,minWidth,zeroPad)}case"e":case"E":case"f":case"F":case"g":case"G":{var number=+value;var prefix=number<0?"-":positivePrefix;var method=["toExponential","toFixed","toPrecision"]["efg".indexOf(type.toLowerCase())];var textTransform=["toString","toUpperCase"]["eEfFgG".indexOf(type)%2];if(precision!=undefined)value=prefix+Math.abs(number)[method](precision);else value=prefix+Math.abs(number)[method]();return justify(value,prefix,leftJustify,minWidth,zeroPad)[textTransform]()}default:return substring}}))}sprintf.regex=/%%|%(\d+\$)?([-+#0 ]*)(\*\d+\$|\*|\d+)?(\.(\*\d+\$|\*|\d+))?([scboxXuidfegEG])/g;return{GetSymValues:GetSymValues,SetSymValues:SetSymValues,GetParValues:GetParValues,SetParValues:SetParValues,UpdateControls:UpdateControls,AutoRefreshStart:AutoRefreshStart,AutoRefreshStop:AutoRefreshStop,GetParList:GetParList,GetMenuList:GetMenuList,GetSymList:GetSymList,ParseBoolean:ParseBoolean,sprintf:sprintf,GetLicenseStatus:GetLicenseStatus,GetRuntimeStatus:GetRuntimeStatus,RegisterLicense:RegisterLicense,GetProductList:GetProductList,GetSystemLog:GetSystemLog,RestartPLC:RestartPLC,StopPLC:StopPLC,StartPLC:StartPLC,GetLicense:GetLicense,ShutdownRuntime:ShutdownRuntime,CheckSessionIsValid:CheckSessionIsValid,Login:Login,Logout:Logout}}();